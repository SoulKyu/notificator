// proto/alert.proto
syntax = "proto3";

package notificator.alert;

option go_package = "notificator/internal/backend/proto/alert";

import "google/protobuf/timestamp.proto";

// Alert Service for comments and acknowledgments
service AlertService {
  // Comments
  rpc AddComment(AddCommentRequest) returns (AddCommentResponse);
  rpc GetComments(GetCommentsRequest) returns (GetCommentsResponse);
  rpc DeleteComment(DeleteCommentRequest) returns (DeleteCommentResponse);
  
  // Acknowledgments
  rpc AddAcknowledgment(AddAcknowledgmentRequest) returns (AddAcknowledgmentResponse);
  rpc GetAcknowledgments(GetAcknowledgmentsRequest) returns (GetAcknowledgmentsResponse);
  rpc GetAllAcknowledgedAlerts(GetAllAcknowledgedAlertsRequest) returns (GetAllAcknowledgedAlertsResponse);
  rpc DeleteAcknowledgment(DeleteAcknowledgmentRequest) returns (DeleteAcknowledgmentResponse);
  
  // Real-time Updates
  rpc SubscribeToAlertUpdates(SubscribeToAlertUpdatesRequest) returns (stream AlertUpdate);
  
  // Resolved Alerts
  rpc CreateResolvedAlert(CreateResolvedAlertRequest) returns (CreateResolvedAlertResponse);
  rpc GetResolvedAlerts(GetResolvedAlertsRequest) returns (GetResolvedAlertsResponse);
  rpc GetResolvedAlert(GetResolvedAlertRequest) returns (GetResolvedAlertResponse);
  rpc RemoveAllResolvedAlerts(RemoveAllResolvedAlertsRequest) returns (RemoveAllResolvedAlertsResponse);
  rpc StreamResolvedAlertUpdates(StreamResolvedAlertUpdatesRequest) returns (stream ResolvedAlertUpdate);
  
  // User Color Preferences
  rpc GetUserColorPreferences(GetUserColorPreferencesRequest) returns (GetUserColorPreferencesResponse);
  rpc SaveUserColorPreferences(SaveUserColorPreferencesRequest) returns (SaveUserColorPreferencesResponse);
  rpc DeleteUserColorPreference(DeleteUserColorPreferenceRequest) returns (DeleteUserColorPreferenceResponse);

  // User Hidden Alerts
  rpc GetUserHiddenAlerts(GetUserHiddenAlertsRequest) returns (GetUserHiddenAlertsResponse);
  rpc HideAlert(HideAlertRequest) returns (HideAlertResponse);
  rpc UnhideAlert(UnhideAlertRequest) returns (UnhideAlertResponse);
  rpc ClearAllHiddenAlerts(ClearAllHiddenAlertsRequest) returns (ClearAllHiddenAlertsResponse);
  
  // User Hidden Rules
  rpc GetUserHiddenRules(GetUserHiddenRulesRequest) returns (GetUserHiddenRulesResponse);
  rpc SaveHiddenRule(SaveHiddenRuleRequest) returns (SaveHiddenRuleResponse);
  rpc RemoveHiddenRule(RemoveHiddenRuleRequest) returns (RemoveHiddenRuleResponse);

  // Notification Preferences
  rpc GetNotificationPreferences(GetNotificationPreferencesRequest) returns (GetNotificationPreferencesResponse);
  rpc SaveNotificationPreferences(SaveNotificationPreferencesRequest) returns (SaveNotificationPreferencesResponse);

  // Filter Presets
  rpc GetFilterPresets(GetFilterPresetsRequest) returns (GetFilterPresetsResponse);
  rpc SaveFilterPreset(SaveFilterPresetRequest) returns (SaveFilterPresetResponse);
  rpc UpdateFilterPreset(UpdateFilterPresetRequest) returns (UpdateFilterPresetResponse);
  rpc DeleteFilterPreset(DeleteFilterPresetRequest) returns (DeleteFilterPresetResponse);
  rpc SetDefaultFilterPreset(SetDefaultFilterPresetRequest) returns (SetDefaultFilterPresetResponse);
}

// Comment Messages
message AddCommentRequest {
  string session_id = 1;
  string alert_key = 2;
  string content = 3;
}

message AddCommentResponse {
  bool success = 1;
  Comment comment = 2;
  string message = 3;
}

message GetCommentsRequest {
  string alert_key = 1;
}

message GetCommentsResponse {
  repeated Comment comments = 1;
  int32 count = 2;
}

message DeleteCommentRequest {
  string session_id = 1;
  string comment_id = 2;
}

message DeleteCommentResponse {
  bool success = 1;
  string message = 2;
}

message Comment {
  string id = 1;
  string alert_key = 2;
  string user_id = 3;
  string username = 4;
  string content = 5;
  google.protobuf.Timestamp created_at = 6;
}

// Acknowledgment Messages
message AddAcknowledgmentRequest {
  string session_id = 1;
  string alert_key = 2;
  string reason = 3;
}

message AddAcknowledgmentResponse {
  bool success = 1;
  Acknowledgment acknowledgment = 2;
  string message = 3;
}

message GetAcknowledgmentsRequest {
  string alert_key = 1;
}

message GetAcknowledgmentsResponse {
  repeated Acknowledgment acknowledgments = 1;
  int32 count = 2;
}

message GetAllAcknowledgedAlertsRequest {
  // No parameters needed - returns all acknowledged alerts
}

message GetAllAcknowledgedAlertsResponse {
  map<string, Acknowledgment> acknowledged_alerts = 1; // alert_key -> latest acknowledgment
  int32 count = 2;
}

message DeleteAcknowledgmentRequest {
  string session_id = 1;
  string alert_key = 2;
}

message DeleteAcknowledgmentResponse {
  bool success = 1;
  string message = 2;
}

message Acknowledgment {
  string id = 1;
  string alert_key = 2;
  string user_id = 3;
  string username = 4;
  string reason = 5;
  google.protobuf.Timestamp created_at = 6;
}

// Real-time Updates Messages
message SubscribeToAlertUpdatesRequest {
  string session_id = 1;
  string alert_key = 2;
}

message AlertUpdate {
  string alert_key = 1;
  UpdateType update_type = 2;
  oneof update_data {
    Comment comment = 3;
    Acknowledgment acknowledgment = 4;
    string deleted_comment_id = 5;
    string deleted_acknowledgment_id = 6;
  }
  google.protobuf.Timestamp timestamp = 7;
}

enum UpdateType {
  UNKNOWN_UPDATE = 0;
  COMMENT_ADDED = 1;
  COMMENT_DELETED = 2;
  ACKNOWLEDGMENT_ADDED = 3;
  ACKNOWLEDGMENT_DELETED = 4;
}

// User Color Preferences Messages
message GetUserColorPreferencesRequest {
  string session_id = 1;
}

message GetUserColorPreferencesResponse {
  repeated UserColorPreference preferences = 1;
  bool success = 2;
  string message = 3;
}

message SaveUserColorPreferencesRequest {
  string session_id = 1;
  repeated UserColorPreference preferences = 2;
}

message SaveUserColorPreferencesResponse {
  bool success = 1;
  string message = 2;
}

message DeleteUserColorPreferenceRequest {
  string session_id = 1;
  string preference_id = 2;
}

message DeleteUserColorPreferenceResponse {
  bool success = 1;
  string message = 2;
}

message UserColorPreference {
  string id = 1;                                    // Unique ID for the preference
  string user_id = 2;                              // User who owns this preference
  map<string, string> label_conditions = 3;       // Key-value pairs: {Team: "team-infrastructure", Severity: "Warning"}
  string color = 4;                                // Color value (e.g., "GRAY", "#FF5733", "red-500")
  string color_type = 5;                           // Type: "severity", "custom", "tailwind"
  int32 priority = 6;                              // Higher numbers = higher priority (for conflicts)
  google.protobuf.Timestamp created_at = 7;
  google.protobuf.Timestamp updated_at = 8;
  float bg_lightness_factor = 9;                   // Background lightness adjustment factor
  float text_darkness_factor = 10;                 // Text darkness adjustment factor
}

// Resolved Alert Messages
message CreateResolvedAlertRequest {
  string fingerprint = 1;
  string source = 2;
  bytes alert_data = 3;        // JSON serialized DashboardAlert
  bytes comments = 4;          // JSON serialized comments array
  bytes acknowledgments = 5;   // JSON serialized acknowledgments array
  int32 ttl_hours = 6;         // TTL in hours (default 24)
}

message CreateResolvedAlertResponse {
  bool success = 1;
  ResolvedAlertInfo resolved_alert = 2;
  string message = 3;
}

message GetResolvedAlertsRequest {
  int32 limit = 1;
  int32 offset = 2;
}

message GetResolvedAlertsResponse {
  repeated ResolvedAlertInfo resolved_alerts = 1;
  int32 total_count = 2;
  bool success = 3;
  string message = 4;
}

message GetResolvedAlertRequest {
  string fingerprint = 1;
}

message GetResolvedAlertResponse {
  bool success = 1;
  ResolvedAlertInfo resolved_alert = 2;
  string message = 3;
}

message RemoveAllResolvedAlertsRequest {
  // No parameters needed - removes all resolved alerts
}

message RemoveAllResolvedAlertsResponse {
  bool success = 1;
  int32 removed_count = 2;
  string message = 3;
}

message StreamResolvedAlertUpdatesRequest {
  string session_id = 1;
}

message ResolvedAlertUpdate {
  string fingerprint = 1;
  ResolvedAlertUpdateType update_type = 2;
  ResolvedAlertInfo resolved_alert = 3;
  google.protobuf.Timestamp timestamp = 4;
}

message ResolvedAlertInfo {
  string id = 1;
  string fingerprint = 2;
  bytes alert_data = 3;        // JSON serialized DashboardAlert
  bytes comments = 4;          // JSON serialized comments array
  bytes acknowledgments = 5;   // JSON serialized acknowledgments array
  google.protobuf.Timestamp resolved_at = 6;
  google.protobuf.Timestamp expires_at = 7;
  string source = 8;
  google.protobuf.Timestamp created_at = 9;
  google.protobuf.Timestamp updated_at = 10;
}

// User Hidden Alerts Messages
message GetUserHiddenAlertsRequest {
  string session_id = 1;
}

message GetUserHiddenAlertsResponse {
  repeated UserHiddenAlert hidden_alerts = 1;
  bool success = 2;
  string message = 3;
}

message HideAlertRequest {
  string session_id = 1;
  string fingerprint = 2;
  string alert_name = 3;
  string instance = 4;
  string reason = 5;
}

message HideAlertResponse {
  bool success = 1;
  UserHiddenAlert hidden_alert = 2;
  string message = 3;
}

message UnhideAlertRequest {
  string session_id = 1;
  string fingerprint = 2;
}

message UnhideAlertResponse {
  bool success = 1;
  string message = 2;
}

message ClearAllHiddenAlertsRequest {
  string session_id = 1;
}

message ClearAllHiddenAlertsResponse {
  bool success = 1;
  int32 cleared_count = 2;
  string message = 3;
}

message UserHiddenAlert {
  string id = 1;
  string user_id = 2;
  string fingerprint = 3;
  string alert_name = 4;
  string instance = 5;
  string reason = 6;
  google.protobuf.Timestamp created_at = 7;
  google.protobuf.Timestamp updated_at = 8;
}

// User Hidden Rules Messages
message GetUserHiddenRulesRequest {
  string session_id = 1;
}

message GetUserHiddenRulesResponse {
  repeated UserHiddenRule hidden_rules = 1;
  bool success = 2;
  string message = 3;
}

message SaveHiddenRuleRequest {
  string session_id = 1;
  UserHiddenRule rule = 2;
}

message SaveHiddenRuleResponse {
  bool success = 1;
  UserHiddenRule rule = 2;
  string message = 3;
}

message RemoveHiddenRuleRequest {
  string session_id = 1;
  string rule_id = 2;
}

message RemoveHiddenRuleResponse {
  bool success = 1;
  string message = 2;
}

message UserHiddenRule {
  string id = 1;
  string user_id = 2;
  string name = 3;
  string description = 4;
  string label_key = 5;
  string label_value = 6;
  bool is_regex = 7;
  bool is_enabled = 8;
  int32 priority = 9;
  google.protobuf.Timestamp created_at = 10;
  google.protobuf.Timestamp updated_at = 11;
}

enum ResolvedAlertUpdateType {
  UNKNOWN_RESOLVED_UPDATE = 0;
  RESOLVED_ALERT_CREATED = 1;
  RESOLVED_ALERT_EXPIRED = 2;
}

// Notification Preferences Messages
message GetNotificationPreferencesRequest {
  string session_id = 1;
}

message GetNotificationPreferencesResponse {
  bool success = 1;
  NotificationPreference preferences = 2;
  string message = 3;
}

message SaveNotificationPreferencesRequest {
  string session_id = 1;
  bool browser_notifications_enabled = 2;
  repeated string enabled_severities = 3;
  bool sound_notifications_enabled = 4;
}

message SaveNotificationPreferencesResponse {
  bool success = 1;
  NotificationPreference preferences = 2;
  string message = 3;
}

message NotificationPreference {
  string id = 1;
  string user_id = 2;
  bool browser_notifications_enabled = 3;
  repeated string enabled_severities = 4;
  bool sound_notifications_enabled = 5;
  google.protobuf.Timestamp created_at = 6;
  google.protobuf.Timestamp updated_at = 7;
}

// Filter Presets Messages
message GetFilterPresetsRequest {
  string session_id = 1;
  bool include_shared = 2;
}

message GetFilterPresetsResponse {
  bool success = 1;
  repeated FilterPreset presets = 2;
  string message = 3;
}

message SaveFilterPresetRequest {
  string session_id = 1;
  string name = 2;
  string description = 3;
  bool is_shared = 4;
  bytes filter_data = 5;  // JSON serialized filter state
}

message SaveFilterPresetResponse {
  bool success = 1;
  FilterPreset preset = 2;
  string message = 3;
}

message UpdateFilterPresetRequest {
  string session_id = 1;
  string preset_id = 2;
  string name = 3;
  string description = 4;
  bool is_shared = 5;
  bytes filter_data = 6;  // JSON serialized filter state
}

message UpdateFilterPresetResponse {
  bool success = 1;
  FilterPreset preset = 2;
  string message = 3;
}

message DeleteFilterPresetRequest {
  string session_id = 1;
  string preset_id = 2;
}

message DeleteFilterPresetResponse {
  bool success = 1;
  string message = 2;
}

message SetDefaultFilterPresetRequest {
  string session_id = 1;
  string preset_id = 2;
}

message SetDefaultFilterPresetResponse {
  bool success = 1;
  string message = 2;
}

message FilterPreset {
  string id = 1;
  string user_id = 2;
  string name = 3;
  string description = 4;
  bool is_shared = 5;
  bool is_default = 6;
  bytes filter_data = 7;  // JSON serialized filter state
  google.protobuf.Timestamp created_at = 8;
  google.protobuf.Timestamp updated_at = 9;
}

// ==================== Statistics Service ====================

// Statistics Service for on-call alert analytics
service StatisticsService {
  // Query statistics with filters and aggregations
  rpc QueryStatistics(QueryStatisticsRequest) returns (QueryStatisticsResponse);

  // On-Call Rules Management
  rpc SaveOnCallRule(SaveOnCallRuleRequest) returns (SaveOnCallRuleResponse);
  rpc GetOnCallRules(GetOnCallRulesRequest) returns (GetOnCallRulesResponse);
  rpc GetOnCallRule(GetOnCallRuleRequest) returns (GetOnCallRuleResponse);
  rpc UpdateOnCallRule(UpdateOnCallRuleRequest) returns (UpdateOnCallRuleResponse);
  rpc DeleteOnCallRule(DeleteOnCallRuleRequest) returns (DeleteOnCallRuleResponse);
  rpc TestOnCallRule(TestOnCallRuleRequest) returns (TestOnCallRuleResponse);

  // Summary and overview
  rpc GetStatisticsSummary(GetStatisticsSummaryRequest) returns (GetStatisticsSummaryResponse);

  // Alert statistics capture events
  rpc CaptureAlertFired(CaptureAlertFiredRequest) returns (CaptureAlertFiredResponse);
  rpc UpdateAlertResolved(UpdateAlertResolvedRequest) returns (UpdateAlertResolvedResponse);
  rpc UpdateAlertAcknowledged(UpdateAlertAcknowledgedRequest) returns (UpdateAlertAcknowledgedResponse);
}

// ==================== Statistics Query Messages ====================

message QueryStatisticsRequest {
  string session_id = 1;
  google.protobuf.Timestamp start_date = 2;
  google.protobuf.Timestamp end_date = 3;
  bool apply_rules = 4;           // Apply user's on-call rules
  string group_by = 5;            // "severity", "team", "period", "alert_name", or empty for overall
  string period_type = 6;         // "hour", "day", "week", "month" (required if group_by="period")
  int32 limit = 7;                // Limit results (for alert_name grouping)
  int32 offset = 8;               // Pagination offset
}

message QueryStatisticsResponse {
  bool success = 1;
  TimeRange time_range = 2;
  int64 total_alerts = 3;
  map<string, AggregatedStatistics> statistics = 4;  // Key varies by group_by
  repeated BreakdownItem breakdown = 5;              // Used for period grouping
  string message = 6;
}

message TimeRange {
  google.protobuf.Timestamp start = 1;
  google.protobuf.Timestamp end = 2;
}

message AggregatedStatistics {
  int32 count = 1;
  double avg_duration_seconds = 2;
  int32 total_duration_seconds = 3;
  double avg_mttr_seconds = 4;
}

message BreakdownItem {
  string period = 1;                                  // e.g., "2025-10-22" or "Week of 2025-10-20"
  google.protobuf.Timestamp start_time = 2;
  google.protobuf.Timestamp end_time = 3;
  int32 total_count = 4;
  map<string, AggregatedStatistics> statistics = 5;  // Breakdown by severity within period
}

// ==================== On-Call Rules Messages ====================

message SaveOnCallRuleRequest {
  string session_id = 1;
  string rule_name = 2;
  RuleConfig rule_config = 3;
  bool is_active = 4;
}

message SaveOnCallRuleResponse {
  bool success = 1;
  OnCallRule rule = 2;
  string message = 3;
}

message GetOnCallRulesRequest {
  string session_id = 1;
  bool active_only = 2;
}

message GetOnCallRulesResponse {
  bool success = 1;
  repeated OnCallRule rules = 2;
  string message = 3;
}

message GetOnCallRuleRequest {
  string session_id = 1;
  string rule_id = 2;
}

message GetOnCallRuleResponse {
  bool success = 1;
  OnCallRule rule = 2;
  string message = 3;
}

message UpdateOnCallRuleRequest {
  string session_id = 1;
  string rule_id = 2;
  string rule_name = 3;
  RuleConfig rule_config = 4;
  bool is_active = 5;
}

message UpdateOnCallRuleResponse {
  bool success = 1;
  OnCallRule rule = 2;
  string message = 3;
}

message DeleteOnCallRuleRequest {
  string session_id = 1;
  string rule_id = 2;
}

message DeleteOnCallRuleResponse {
  bool success = 1;
  string message = 2;
}

message TestOnCallRuleRequest {
  string session_id = 1;
  RuleConfig rule_config = 2;
  int32 sample_size = 3;  // Number of sample alerts to return
}

message TestOnCallRuleResponse {
  bool success = 1;
  int64 total_matches = 2;
  repeated AlertStatistic sample_alerts = 3;
  string message = 4;
}

message OnCallRule {
  string id = 1;
  string user_id = 2;
  string rule_name = 3;
  RuleConfig rule_config = 4;
  bool is_active = 5;
  google.protobuf.Timestamp created_at = 6;
  google.protobuf.Timestamp updated_at = 7;
}

message RuleConfig {
  repeated RuleCriterion criteria = 1;
  string logic = 2;  // "AND" or "OR"
}

message RuleCriterion {
  string type = 1;        // "severity", "label", "alert_name"
  string operator = 2;    // "equals", "in", "not_equals", "contains", "regex", "starts_with", "ends_with"
  string value = 3;       // Single value (for equals, not_equals, contains, etc.)
  repeated string values = 4;  // Multiple values (for "in" operator)
  string key = 5;         // Label key (for label type)
  string pattern = 6;     // Pattern/regex (for alert_name type)
}

message AlertStatistic {
  string id = 1;
  string fingerprint = 2;
  string alert_name = 3;
  string severity = 4;
  bytes metadata = 5;  // JSON serialized metadata
  google.protobuf.Timestamp fired_at = 6;
  google.protobuf.Timestamp resolved_at = 7;
  google.protobuf.Timestamp acknowledged_at = 8;
  int32 duration_seconds = 9;
  int32 mttr_seconds = 10;
  google.protobuf.Timestamp created_at = 11;
  google.protobuf.Timestamp updated_at = 12;
}

// ==================== Statistics Summary Messages ====================

message GetStatisticsSummaryRequest {
  string session_id = 1;
}

message GetStatisticsSummaryResponse {
  bool success = 1;
  int64 total_statistics = 2;
  map<string, AggregatedStatistics> by_severity = 3;
  google.protobuf.Timestamp earliest_alert = 4;
  google.protobuf.Timestamp latest_alert = 5;
  string message = 6;
}

// ==================== Alert Capture Messages ====================

message CaptureAlertFiredRequest {
  string fingerprint = 1;
  string alert_name = 2;
  string severity = 3;
  google.protobuf.Timestamp starts_at = 4;
  bytes metadata = 5; // JSON metadata containing labels, annotations, etc.
}

message CaptureAlertFiredResponse {
  bool success = 1;
  string message = 2;
}

message UpdateAlertResolvedRequest {
  string fingerprint = 1;
  google.protobuf.Timestamp resolved_at = 2;
}

message UpdateAlertResolvedResponse {
  bool success = 1;
  string message = 2;
}

message UpdateAlertAcknowledgedRequest {
  string fingerprint = 1;
  google.protobuf.Timestamp acknowledged_at = 2;
}

message UpdateAlertAcknowledgedResponse {
  bool success = 1;
  string message = 2;
}